## تحليل نظام نقاط البيع (POS) – مرجع فني للتطوير

### 1) نظرة عامة

- **الغرض**: نظام نقاط بيع وإدارة مخزون ومحاسبة مصغر لشركة/متجر متعدد الفروع.
- **المنصة**: PHP (نمط برمجي إجرائي/مختلط)، MySQL، واجهة أمامية تعتمد على jQuery وملحقاته.
- **النطاق**: إدارة المبيعات، المشتريات، العملاء، الموردين، الجرد والتحويلات، الإعدادات العامة، الفواتير والتقارير، الطباعة الحرارية.

### 2) التقنيات والمكتبات المستخدمة

- **الخلفية**: PHP + MySQL. الاتصال يظهر في `db.conn.php` مع إعدادات محلية.
- **الواجهة**: jQuery 1.9.x، Bootstrap (من خلال ملفات `header.php`/`include.php`)، Chosen، jQuery UI، DataTables، وغيرها (`js/` و`css/`).
- **التقارير والطباعة**:
  - `reports/` يحتوي TCPDF وPHPExcel (تصدير PDF/Excel).
  - مجلد `escpos/` يحوي `mike42/escpos-php` للطابعات الحرارية.
- **اللغات**: دعم ثنائي اللغة (متغيرات مثل `LANGUAGE_1`, `LANGUAGE_2`، وتعريفات نصوص عبر `translate.php`).

### 3) بنية المشروع (مختصرة)

- ملفات صفحات عليا في الجذر: `index.php`, `pos.php`, `settings.php`, ... لكل وظيفة صفحة مستقلة.
- وحدة تحكم رئيسية: `controller.php` (كبيرة الحجم، تجمع وظائف CRUD وإجراءات أعمال متعددة: مبيعات، إعدادات، بحث أصناف...).
- الاتصال بقاعدة البيانات: `db.conn.php`.
- ملفات الهيكل العام للواجهة: `top.php`, `header.php`, `header_top.php`, `left_menu.php`, `footer.php`, `include.php`.
- تقارير: `reports/` (مئات ملفات PHP للتقارير والقوالب).
- طباعة حرارية: `escpos/` مع المكتبات والموارد.
- أصول الواجهة: `css/`, `js/`, `img/`, `font/` وملحقاتها.
- مصادر/أمثلة الطباعة: `src/` (عينات وملفات توضيحية مرتبطة بالطباعة والتشفير).

### 4) المهام والخصائص الأساسية للنظام

- **المبيعات (POS)**:
  - فتح معاملة وربطها بالمستخدم والفرع والمتجر الافتراضي (`pos.php` ينشئ/يتابع `transactions`).
  - البحث عن الأصناف بالاسم/الباركود (دالة `search_items` في `controller.php`).
  - إضافة أصناف وسعر/كمية/خصم/ضريبة وتجميع الإجماليات.
  - حفظ فاتورة بيع وتوليد قيود محاسبية تلقائية (إدخالات `journal`/`journal_items`).
  - خيارات دفع متعددة: نقد/فيزا/مدى وحساب المتبقي.
  - ربط التسليم: إدخال هاتف/عنوان، حساب تكلفة التوصيل (قراءة من جدول `delivery`).
- **العملاء**:
  - إدارة العملاء وإضافة سريع من شاشة المبيعات (`addCustomer` عبر `pos.php`).
  - خصومات/ضرائب مخصصة وربط أكواد حسابية.
- **المشتريات/الإرجاعات**:
  - صفحات لإضافة فواتير شراء وإرجاع (`add_purchase.php`, `purchaseRet.php`, ...). تنعكس على المخزون ودفاتر اليومية.
- **المخزون**:
  - التحويل بين المخازن (`stores-transfer.php`, `add_storeTrans.php`).
  - إدارة الأصناف والفئات والوحدات والمخازن (`items.php`, `categories.php`, `units.php`, `stores.php`).
  - تتبع حركة الصنف (`item-movement.php`).
- **المحاسبة**:
  - اليومية وقيود القيد (`journal.php`, توليد قيود من عمليات البيع/الشراء).
  - الدخل والمصروفات (`income`, `outgo` والجداول المرتبطة).
  - الحسابات والميزانية (`accounts.php`, `budget.php`).
- **الإعدادات**:
  - الإعدادات العامة (`settings.php`, دالة `updateSettings`): اسم الشركة، الشعار، النشاط، ضرائب، خيارات سلوكية مثل السالب في المخزون.
- **التقارير**:
  - تقارير متنوعة بيع/شراء/مخزون/مالية (كثيرة ضمن `reports/`).
- **الطباعة**:
  - دعم طابعات إيصالات حرارية عبر ESC/POS.
  - توليد PDF/Excel للتقارير والفواتير.

### 5) التدفقات الرئيسية (مختصرة)

- تدفق بيع قياسي:
  1. المستخدم يفتح شاشة `pos.php` → يتم تهيئة معاملة مفتوحة (أو استئناف الحالية).
  2. البحث عن صنف وإضافته → حساب الإجماليات والخصومات والضريبة.
  3. اختيار عميل أو إضافة جديد سريعًا.
  4. اختيار طرق الدفع → حفظ الفاتورة → إنشاء قيود محاسبية → تحديث المخزون.
  5. طباعة إيصال أو تصدير.

### 6) أبرز الملفات/الدوال ذات الصلة

- `controller.php`:
  - `search_items()` للبحث في الأصناف.
  - `addCustomer()` لإضافة عميل.
  - `updateSettings()` لتحديث الإعدادات العامة.
  - إجراءات إنشاء/تحديث فواتير البيع: دوال مثل `setSales(...)` تتعامل مع `sales` و`outgo` و`journal` و`*_items`.
- `db.conn.php`: إعداد اتصال MySQL وضبط الترميز.
- `include.php`: تحميل معظم سكربتات الواجهة (jQuery/Plugins/Custom).
- صفحات CRUD عديدة لكل كيان: `add_*`, `edit_*`, `*_report.php`.

### 7) ملاحظات فنية ومخاطر حالية

- **أمن**:
  - اتصال قاعدة البيانات بإعدادات افتراضية (root بدون كلمة مرور) داخل الكود (`db.conn.php`).
  - غياب واضح لطبقة حماية CSRF على الطلبات POST.
  - استخدام عبارات SQL نصية مباشرة واحتمالية حقن SQL لغياب الربط المُحضّر في مواضع كثيرة.
  - تسريب مسارات وقيم حساسة محتملة في رسائل `die(mysqli_error(...))`.
  - إدارة الجلسات والصلاحيات تبدو مبعثرة وغير موحدة، وغياب RBAC صريح.
- **هيكلة وجودة كود**:
  - `controller.php` متضخم ويحتوي وظائف متعددة غير مترابطة.
  - خلط واجهات وجافاسكربت منسدل داخل الصفحات، وCSS/JS مخصص متداخل.
  - غياب طبقات واضحة: (عرض/View) منفصل عن (منطق/Service) وعن (وصول بيانات/Repository).
- **أداء**:
  - استعلامات متعددة لكل عملية دون كاش أو فهارس مدروسة.
  - تحميل أصول كثيرة لكل صفحة من دون تجميع/تصغير.
- **قابلية الصيانة**:
  - تكرار صفحتي `add_*`/`edit_*` بنمط متشابه دون مكوّنات مشتركة.
  - عدم وجود اختبارات تلقائية.
- **النشر والإعداد**:
  - لا يوجد `.env` أو إدارة أسرار، ولا سكربتات تهيئة/ترحيل قاعدة بيانات production.

### 8) توصيات تطوير وتحسين (مرتبة بالأولوية)

#### أ) أمن وحوكمة (عاجل)

- استخدام ملف إعدادات بيئية `.env` واعتماد `vlucas/phpdotenv` أو اعتماد إطار خفيف يدعم ذلك.
- استبدال جميع SQL بـ Prepared Statements (MySQLi Prepared أو PDO) وإزالة `die(mysqli_error...)` من الاستجابة للمستخدم مع تسجيل داخلي فقط.
- إضافة CSRF Tokens للنماذج وقيود صلاحيات RBAC (أدوار: مدير، محاسب، أمين صندوق، مخزّن...).
- تشفير وحماية جلسات المستخدم وتفعيل ضوابط مدة الجلسة وإغلاقها.

#### ب) هيكلة وتقسيم المنطق (قصير–متوسط)

- تفكيك `controller.php` إلى وحدات: `SalesController`, `InventoryController`, `SettingsController`, `ReportsController`.
- إنشاء طبقة وصول بيانات `Repository` لكل كيان، وطبقة خدمات `Service` للمنطق التجاري.
- تعريف معاملات/DTOs بدلًا من العمل المباشر على `$_POST/$_GET` داخل الخدمات.
- توحيد الاستجابات: JSON/HTML بشكل واضح، مع معالجة أخطاء موحدة.

#### ج) قاعدة البيانات والأداء

- إضافة فهارس على الحقول الشائعة البحث (مثل `barcode`, `itemid`, `invoice_No`, `date`, `storeid`, ...).
- تفعيل كاش طبقي للقراءات المتكررة (APCu/Redis إذا توفر)، خاصة مع البحث عن الأصناف.
- تطبيق ترقيم صفحات (Pagination) في الاستعلامات الطويلة.
- مراجعة القيود والعلاقات (FKs) والتأكد من سلامة المراجع عند الحذف المنطقي/الفزيائي.

#### د) الواجهة وتجربة المستخدم

- تجميع/تصغير الأصول عبر `vite` أو `webpack`، وتقليل عدد السكربتات المحملة في كل صفحة.
- استبدال الإضافات القديمة بإصدارات حديثة أو بمكتبات خفيفة.
- تحسين نماذج الإدخال: تحقق فوري من القيم، رسائل خطأ واضحة، تمييز الحقول المطلوبة.
- تحسين دعم لوحة المفاتيح وقراءة الشاشة (إتاحة/Accessibility)، وتحسين دعم اللغتين مع اتجاه RTL متسق.
- إضافة إشعارات موحدة Succcess/Error.

#### هـ) قابلية الصيانة والجودة

- إضافة طبقة تسجيل Logs (Monolog) مع مستويات مناسبة وارتباط بالطلبات/المستخدم/الفرع.
- تعريف اختبارات وحدات لخدمات المبيعات والمخزون، واختبارات تكامل للعمليات الحرجة (إغلاق فاتورة، تحويل مخزن).
- إنشاء توثيق مطوّر (Developer Guide) وتوثيق REST-like لنقاط النهاية الداخلية.

#### و) النشر والتشغيل

- إضافة Composer لإدارة الاعتمادات بشكل صريح خارج مجلدات المشروع، وتحديث المكتبات.
- سكربتات ترحيل DB (migrations) وتهيئة أولية (seeders).
- إعدادات بيئة متعددة: dev/staging/prod مع إعدادات اتصال آمنة.
- دعم حاويات (Docker) لتوحيد بيئة التطوير.
- إعداد نسخ احتياطي DB دوري وسيناريو استعادة.

### 9) تغييرات تصميم صفحات مقترحة (نمطيًا)

- صفحة POS (`pos.php`):
  - شريط موجز أعلى الفاتورة: رقم المعاملة، الفرع، المتجر، المستخدم، وقت الفاتورة.
  - منطقة بحث موحدة بالأيقونات ودعم ماسح الباركود، وعرض نتائج منسّق مع صورة مصغرة للصنف ومخزون متاح.
  - جدول أصناف سطرّي ثابت الأعمدة مع إجماليات محدثة لحظيًا، وأزرار سريعة لزيادة/نقص الكمية.
  - لوحة دفع جانبية واضحة تقبل طرق دفع متعددة مع التحقق الفوري للمتبقي.
  - زر إتمام/حفظ واضح، مع خيار الطباعة أو الإرسال عبر البريد.
- شاشات CRUD: توحيد قوالب الإدخال، وإعادة استخدام مكوّنات إدخال مشتركة (اسم، هاتف، ضريبة...).
- التقارير: فلاتر واضحة أعلى الجدول، ترقيم صفحات، وتصدير موحد (PDF/Excel/CSV).

### 10) خطة تنفيذ تدريجية (عملية)

1. أمن سريع: `.env` + إخفاء أخطاء SQL + CSRF + جلسات آمنة.
2. إعداد Composer ونقل المكتبات إلى `vendor/` وتحديثها، وإخراج الاعتمادات القديمة من `www` عند الإمكان.
3. تفكيك `controller.php` إلى وحدات، وبناء طبقة `Repository` + `Service` للمبيعات أولًا.
4. استبدال استعلامات المبيعات بـ Prepared Statements، ثم توسيع ذلك لبقية الوحدات.
5. تحسين واجهة POS حسب المقترح، وتجميع الأصول عبر أداة بناء حديثة.
6. إضافة اختبارات وحدات لخدمة المبيعات، وتغطية سيناريوهات الحفظ والطباعة.
7. فهارس DB، وتحسينات الأداء (Pagination/Cache).
8. توثيق مطوّر وتحديث هذا المستند دوريًا مع كل تعديل.

### 11) ملحق – جداول وكيانات رئيسية (استدلالًا من الكود)

- `items`, `categories`, `units`, `stores` و`store_trans/_items`.
- `customers`, `suppliers`.
- `sales`, `sales_items`, `purchase`, `purchase_items`, `salesRet`, `purchaseRet` (أو ما شابه وفق التسمية).
- `journal`, `journal_items` (القيود المحاسبية).
- `income`, `outgo` وملحقاتها.
- `transactions` (معاملات المستخدم المفتوحة).
- `main_settings`, `employees`, `delivery`، وجداول إعدادات أخرى.

### 12) الاتفاقيات المقترحة للتسمية والتوثيق

- أسماء موحّدة للجداول والأعمدة (snake_case) ووثيقة مواصفات قاعدة البيانات.
- أسماء دوال واضحة (أفعال)، وفصل الوظائف العامة عن واجهات العرض.
- إضافة تعليقات مقتضبة فقط عند الضرورة (قواعد/قيود غير بديهية).

---

هذا المستند مرجع تشغيلي/تطويري أولي. يُحدّث بالتزامن مع كل تغيير بنيوي أو تغييرات جوهرية في الواجهات/التدفقات.
